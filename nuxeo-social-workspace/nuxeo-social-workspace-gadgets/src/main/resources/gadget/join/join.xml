<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Join Us"
    description="Join to Social Workspace gadget"
    author="Eugen Ionica" author_email="ei@nuxeo.com"
    height="420">
    <Require feature="setprefs"/>
    <#include "dynamic-translations.ftl"/>
    <Require feature="dynamic-height" />
    <#include "default-oauth-prefs.ftl"/>
  </ModulePrefs>
  <#include "context-prefs.ftl"/>
  <Content type="html">

<![CDATA[
<html>
  <head>

  <link rel="stylesheet" type="text/css" href="/nuxeo/site/skin/gadgets/css/gadget-common.css"/>
  <link rel="stylesheet" type="text/css" href="join.css"/>

  <!-- insert JS Context -->
  ${jsContext}

  <script src="${specDirectoryUrl}default-automation-request.js"></script>
  <script src="${specDirectoryUrl}context-management.js"></script>

  <script>
   var prefs = new _IG_Prefs(__MODULE_ID__);

   var socialWorkspacePath = getTargetContextPath();
   var getSocialWorkspaceQuery = 'select * from SocialWorkspace where ecm:path = \'' + socialWorkspacePath + '\'';


   var NXRequestParams = {
       operationId : 'SocialWorkspace.UserStatus',
       operationParams : {
        contextPath : socialWorkspacePath
       },
       entityType : 'blob',
       operationContext : {},
       operationCallback : displayStatus
   }



  function disableButton() {
    _gel("statusMessage").innerHTML = "__MSG_label.request.registered__";
    _gel("joinButton").style.display = 'none';
  }

  function displaySocialWorkspaceDescription(entries) {
    var msg = ""
    if ( entries.length > 0 ) {
      msg = entries[0].properties["dc:description"];
    }
    _gel("socialWorkspaceDescription").innerHTML = msg;
    gadgets.window.adjustHeight();
  }

  function displayStatus(response, nxParams) {
    var status = response.data["status"];
       _gel("socialWorkspaceDescription").innerHTML = response.data["description"];
    if ( "REQUEST_PENDING" == status ) {
      _gel("statusMessage").innerHTML = "__MSG_label.request.alreadyRegistered__";
      _gel("joinButton").style.display = 'none';
    }
    if ( "MEMBER" == status ) {
      var html = '';
      html += '<p>';
      html += prefs.getMsg('label.request.alreadyMember1');

      var locationHref = window.parent.location.href;
      var index = locationHref.indexOf('?');
      if (index > -1) {
        locationHref = locationHref.substring(0, index);
      }
      locationHref = locationHref.substring(locationHref.indexOf(NXGadgetContext.clientSideBaseUrl)
        + NXGadgetContext.clientSideBaseUrl.length);
      var link = NXGadgetContext.clientSideBaseUrl + 'logout?requestedUrl=' + encodeURIComponent(encodeURIComponent(locationHref.replace(NXGadgetContext.clientSideBaseUrl, '')));
      html += ' <a href="' + link + '" target="_top">' + prefs.getMsg('label.request.alreadyMember2') + '</a> ';
      html += prefs.getMsg('label.request.alreadyMember3');
      html += '</p>';

      _gel("statusMessage").innerHTML = html;
      _gel("joinButton").style.display = 'none';
    }
    gadgets.window.adjustHeight();
  }

   // execute automation request onload
   gadgets.util.registerOnLoadHandler(function() {
     doAutomationRequest(NXRequestParams);
     gadgets.window.adjustHeight();
   });

   var NXJoinRequestParams = {
     operationId : 'Social.Join',
     operationParams : {
      contextPath : socialWorkspacePath
     },
     operationContext : {},
     operationCallback : function() {
      doAutomationRequest(NXRequestParams);
     }
   }

   function joinSocialWorkspace() {
     doAutomationRequest(NXJoinRequestParams);
   };

  </script>
  </head>
    <body>

      <div id="content">
        <#include "default-request-controls.ftl"/>
        <p id="socialWorkspaceDescription" class="socialWorkspaceDescription">
        </p>
        <div class="joinMessage">
          <div id="statusMessage">__MSG_label.gadget.joinDescription__</div>
          <button onClick="joinSocialWorkspace()" id="joinButton">__MSG_label.gadget.joinButton__</button>
        </div>
      </div>
    </body>
</html>
]]>
  </Content>
</Module>
